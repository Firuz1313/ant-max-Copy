# ANT Support Backend

Backend API для системы диагностики ТВ-приставок ANT Support.

## Обзор

Система предоставляет RESTful API для управления диагностическими процедурами, устройствами, пользователями и настройками системы.

## Технологии

- **Node.js** с **Express.js**
- **PostgreSQL** - основная база данных
- **ES6 Modules** - современный JavaScript
- **RESTful API** - стандартная архитектура

## Структура проекта

```
backend/
├── src/
│   ├── controllers/     # Контроллеры API
│   ├── models/         # Модели данных
│   ���── routes/         # Маршруты API
│   ├── middleware/     # Промежуточное ПО
│   └── utils/          # Утилиты и помощники
├── data/               # JSON файлы с данными
├── migrations/         # SQL миграции базы данных
└── server.js          # Точка входа приложения
```

## Модели данных

### Основные модели

1. **BaseModel** - Базовая модель с общими методами
2. **Device** - ТВ-приставки и устройства
3. **Problem** - Диагностические проблемы
4. **DiagnosticStep** - Пошаговые инструкции
5. **DiagnosticSession** - Сессии диагностики пользователей
6. **Remote** - Пульты дистанционного управления
7. **TVInterface** - Интерфейсы и скриншоты ТВ
8. **TVInterfaceMark** - Интерактивные отметки на интерфейсах
9. **User** - Пользователи и администраторы

### Дополнительные модели

10. **SessionStep** - Выполненные шаги в сессиях
11. **StepAction** - Действия для шаго�� диагностики
12. **ChangeLog** - Журнал изменений и аудит
13. **SiteSetting** - Настройки системы

## API Эндпоинты

### Основные ресурсы

- **GET/POST/PUT/DELETE** `/api/v1/devices` - Управление устройствами
- **GET/POST/PUT/DELETE** `/api/v1/problems` - Управление проблемами
- **GET/POST/PUT/DELETE** `/api/v1/steps` - Управление шагами диагностики
- **GET/POST/PUT/DELETE** `/api/v1/sessions` - Управление сессиями
- **GET/POST/PUT/DELETE** `/api/v1/remotes` - Управление пультами
- **GET/POST/PUT/DELETE** `/api/v1/tv-interfaces` - Управление ТВ интерфейсами
- **GET/POST/PUT/DELETE** `/api/v1/users` - Управление пользователями

### Дополнительные ресурсы

- **GET/POST/PUT** `/api/v1/session-steps` - Шаги в сессиях
- **GET/POST/PUT/DELETE** `/api/v1/step-actions` - Действия шагов
- **GET/POST** `/api/v1/change-logs` - Журнал изменений
- **GET/PUT** `/api/v1/settings` - Настройки системы

### Служебные эндпоинты

- **GET** `/api/health` - Проверка состояния API
- **GET** `/api/info` - Информация об API
- **GET** `/api/docs` - Документация API

## База данных

### Миграции

Система использует SQL миграции для управления схемой базы данных:

```bash
# Проверить статус миграций
npm run db:migrate:status

# Запустить все миграции
npm run db:migrate:up

# Откатить последнюю миграцию (только для разработки)
npm run db:migrate:rollback

# Альтернативно, использовать скрипт напрямую
node run-migrations.js status
node run-migrations.js up
```

### Доступные миграции

1. **001_init_tables.sql** - Создание всех основных таблиц
2. **002_add_indexes.sql** - Добавление индексов для производительности
3. **003_initial_data.sql** - Начальные данные и настройки

### Схема базы данных

Подробная схема базы данных описана в `database_schema.md`.

## Установка и запуск

### Требования

- Node.js 18+
- PostgreSQL 13+
- npm или yarn

### Установка

```bash
# У��тановить зависимости
npm install

# Настроить переменные окружения
cp .env.example .env
# Отредактировать .env файл

# Запустить миграции базы данных
npm run db:migrate:up

# Инициализировать базу данных (опционально)
npm run db:init
```

### Запуск

```bash
# Режим разработки
npm run dev

# Продакшн режим
npm start

# Запуск только backend (если фронтенд отдельно)
npm run dev:backend
```

## Переменные окружения

```env
# База данных
DB_HOST=localhost
DB_PORT=5432
DB_NAME=ant_support
DB_USER=your_user
DB_PASSWORD=your_password

# Сервер
PORT=3001
NODE_ENV=development

# Безопасность
JWT_SECRET=your_jwt_secret
BCRYPT_ROUNDS=12

# CORS
CORS_ORIGINS=http://localhost:3000,http://localhost:5173
```

## Разработка

### Добавление новой модели

1. Создать модель в `src/models/`
2. Создать контроллер в `src/controllers/`
3. Создать маршруты в `src/routes/`
4. Добавить маршруты в `src/routes/index.js`
5. Создать миграцию в `migrations/`
6. Добавить JSON файл данных в `data/`

### Создание миграции

```bash
# Создать новый файл миграции
# Формат: XXX_description.sql
touch migrations/004_new_feature.sql
```

### Тестирование

```bash
# Запустить тесты
npm test

# Линтинг
npm run lint

# Форматирование кода
npm run format
```

## API Документация

### Формат ответов

#### Успешный ответ
```json
{
  "success": true,
  "data": {},
  "message": "Опциональное сообщение",
  "pagination": {},
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

#### Ошибка
```json
{
  "success": false,
  "error": "Описание ошибки",
  "errorType": "VALIDATION_ERROR",
  "details": [],
  "suggestion": "Рекомендация по исправлению",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### Коды ошибок

- **400** - Bad Request (валидация, параметры)
- **401** - Unauthorized (требуется авторизация)
- **403** - Forbidden (недостаточно прав)
- **404** - Not Found (ресурс не найден)
- **409** - Conflict (дубликаты, ограничения)
- **422** - Unprocessable Entity (бизнес-логика)
- **500** - Internal Server Error (внутренняя ошибка)

## Мониторинг и логирование

### Логи

Система ведет подробные логи всех операций:

- HTTP запросы (Morgan)
- Ошибки базы данных
- Изменения данных (ChangeLog)
- Аудит пользователей

### Метрики

- Время ответа API
- Статистика использования
- Аналитика диагностических сессий
- Производительность базы данных

## Безопасность

### Реализованные меры

- Валидация входных данных (Joi)
- Защита от SQL инъекций (параметризованные запросы)
- Хеширование паролей (bcrypt)
- Rate limiting
- CORS защита
- Helmet.js для заголовков безопасности

### Рекомендации

- Использовать HTTPS в продакшне
- Регулярно обновлять зависимости
- Настроить мониторинг безопасности
- Проводить аудит кода

## Производительность

### Оптимизации

- Индексы базы данных
- Пагинация результатов
- Кеширование (планируется)
- Сжатие ответов
- Оптимизированные SQL запросы

### Мониторинг

- Медленные запросы
- Использование памяти
- CPU нагрузка
- Соединения с БД

## Поддержка

### Отладка

```bash
# Проверить состояние API
curl http://localhost:3001/api/health

# Получить информацию об API
curl http://localhost:3001/api/info

# Просмотреть логи
npm run logs
```

### Частые проблемы

1. **Ошибка подключения к БД** - проверить .env файл
2. **Порт занят** - изменить PORT в .env
3. **Миграции не применяются** - проверить права доступа к БД

## Вклад в разработку

1. Fork репозитория
2. Создать feature ветку
3. Внести изменения
4. Добавить тесты
5. Создать Pull Request

## Лицензия

MIT License - см. LICENSE файл для ��еталей.
